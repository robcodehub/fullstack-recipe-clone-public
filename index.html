<html>
  <head>
    <script src='/dist/main.js' defer></script>

    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.4/redux.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-redux/7.1.1/react-redux.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.1/react-router-dom.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux-thunk/2.3.0/redux-thunk.js'></script>

    <style>

      body {
        font-family: helvetica;
      }

      nav {
        display: flex;
        justify-content: space-around;
      }

      #new-recipe-form {
        display: flex;
        flex-direction: column;
        margin: 1rem;
        padding: 1rem;
      }

      #new-recipe-form > input{
        margin: 0.2rem;
        padding: 0.2rem;
      }

      #new-recipe-form > select{
        margin: 0.2rem;
        padding: 0.2rem;
      }

    </style>

  </head>
  <body>
    <div id='root'>
    </div>


    <script type='text/babel'>

    //root = div with id of root
    const root = document.querySelector('#root')
    //deconstructing from CDNs - less typing, less griping
    const { Component } = React;
    const { render } = ReactDOM;
    const { HashRouter, Link, Route} = ReactRouterDOM;
    const { createStore, combineReducers, applyMiddleware } = Redux;
    const { thunkMiddleware, thunk, createThunkMiddleware } = ReduxThunk;
    const { connect, Provider } = ReactRedux;

    //REDUX - ACTION TYPES
    const SET_RECIPES = 'SET_RECIPES'
    const ADD_RECIPE = 'ADD_RECIPE'
    const DELETE_RECIPE = 'DELETE_RECIPE'

    const SET_USERS = 'SET_USERS'
    const ADD_USER = 'ADD_USER'
    const DELETE_USER = 'DELETE_USER'




    //REDUX - ACTION CREATORS

    const setRecipesAction = (recipes) => ({type: SET_RECIPES, recipes})
    const addRecipeAction = (recipe) => ({type: ADD_RECIPE, recipe})

    const setUsersAction = (users) => ({type: SET_USERS, users})
    const addUserAction = (recipe) => ({type: ADD_USER, user})

    //REDUX - AXIOS - FETCH RECIPES / USERS AND ADD TO STORE

    const fetchRecipes = async() => store.dispatch({type: SET_RECIPES, recipes: (await axios.get('/api/recipes')).data})

    const fetchUsers = async() => store.dispatch({type: SET_USERS, users: (await axios.get('/api/users')).data})




    //REFACTORING WITH THUNKS

    //RECIPE THUNKS

    const setRecipesThunk = () => {
      return async dispatch => {
        const allRecipes = (await axios.get('/api/recipes')).data;
        dispatch(setRecipesAction(allRecipes))
      }
    }

    const addRecipeThunk = (recipe) => {
      return async dispatch => {
        const postRecipe = (await axios.post('/api/recipes', recipe)).data;
        dispatch(addRecipeAction(postRecipe))
        }
    }


    //USER THUNKS

    const setUsersThunk = () => {
      return async dispatch => {
        const allUsers = (await axios.get('/api/users')).data;
        dispatch(setUsersAction(allUsers))
      }
    }


    const addUserThunk = (user) => {
      return async dispatch => {
        const postUser = (await axios.post('/api/users', user)).data;
        dispatch(addUserAction(postUser))
        }
    }



    //REDUX - REDUCERS
    const userReducer = (state = [], action) => {
      //ADD IF ACTION.TYPE HERE
      if (action.type === SET_USERS) {
        state = action.users;
      } else if (action.type === ADD_USER) {
          return [...state, action.user]
      } else if (action.type === DELETE_USER) {
          return state.users.filter(user => user.id !== action.user.id)
      }
      return state;
    }

    const recipeReducer = (state = [], action) => {
      //ADD IF ACTION.TYPE HERE
      if (action.type === SET_RECIPES) {
          state = action.recipes;
      } else if (action.type === ADD_RECIPE) {
          return [...state, action.recipe]
      } else if (action.type === DELETE_RECIPE) {
          return state.recipes.filter(recipe => recipe.id !== action.recipe.id)
      }
      return state;
    }


    //REDUX - COMBINE REDUCERS
    const reducer = combineReducers({
      users: userReducer,
      recipes: recipeReducer
    });

    //REDUX - CREATE REDUX STORE
      const store = createStore(reducer) //, applyMiddleware(thunkMiddleware));

      //REDUX STORE WITH MIDDLEWARE
      //const store = createStore(reducer, applyMiddleware(thunkMiddleware));



//////////////////////HOME CONNECTED COMPONENT////////////////////////////////////
    const _Home = ({users, recipes}) => {
      console.log("RECIPES ON HOME PAGE SHOW...", recipes)
      let allRecipes = [];
      recipes


    return (
          <div>
            Welcome! {users.length} users and {recipes.length} recipes coming soon...

            <HealthyRecipes />
            The top chef is...
          </div>
        )
    }

    //HOME CONNECTED COMPONENT
    const Home = connect(({users, recipes}) => {
      return {
        users,
        recipes
      }
    })(_Home)



//////////////////////RECIPE CONNECTED COMPONENT////////////////////////////////////
    const _Recipes = ({recipes}) => {
      const chefsTest = recipes.filter(recipe => recipe.user)
      console.log("RECIPES =======", recipes)
      console.log("RECIPES WITH CHEF =======", chefsTest)
      return (
        <div>
          {recipes.map(recipe => <div key = {recipe.id} > <br /> Name: {recipe.name} <br /> Cuisine: {recipe.cuisine} <br /> Health Score: {recipe.healthScore} <br /> Ingredients: {recipe.ingredients} <br /> Directions: {recipe.directions} <br /> Image: <br /> <img height="250" width="250" src={recipe.imageURL} /> <Link to={`/recipes/${recipe.id}`}>Link to Recipe</Link> </div>)}
          <br /> <br />
          <AddNewRecipeForm />
        </div>
      )
    }

    //RECIPE CONNECTED COMPONENT
    const Recipes = connect(({recipes}) => {
      return {
        recipes
      }
    })(_Recipes)


//////////////////////USERS CONNECTED COMPONENT////////////////////////////////////
    const _Users = ({users}) => {
      return (
        <div>
          {users.length} Users coming soon...
          {users.map(user => <div key={user.id}> <br /> Chef Name: {user.username} <br /> Chef Score: {user.chefScore} <br /> Profile Image: <br /> <img height="150" width="150" src={user.imageURL} /> <Link to={`/users/${user.id}`}> Link to User</Link> <br /></div>)}
        </div>
      )
    }

    //USERS CONNECTED COMPONENT
    const Users = connect(({users}) => {
      return {
        users
      }
    })(_Users);


  //////////////////////NAV CONNECTED COMPONENT////////////////////////////////////
    const _Nav = ({recipes, users}) => {
      return (
        <nav>
          <Link to='/'> Home </Link>
          <Link to='/users'> Users ({users.length}) </Link>
          <Link to='/recipes'> Recipes ({recipes.length})</Link>
          <Link to='/chefs'> Chefs ({(recipes.filter(recipe => recipe.userId !== null)).length})</Link>

        </nav>
      )
    }

    //NAV CONNECTED COMPONENT
    const Nav = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_Nav)



  //////////////////////CHEFS CONNECTED COMPONENT////////////////////////////////////
    //{recipes.filter(recipe => recipe.user)}
    const _Chefs = ({recipes, users}) => {

      const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)

      console.log("All CHEFS====", allChefs)



      /*
      const reducedChefs = allChefs.reduce((all, chef) => {
        if (!all[chef.id]) {
          all[chef.id] = chef;
        }
        return all;
      }, {});

      const reducedArr = [];
      reducedArr.push(reducedChefs);

      console.log("REDUCED Arr =======", reducedArr)

      console.log("REDUCED CHEFS =======", reducedChefs)
      */

      return (
        <div>
          {allChefs.map(chef => <div key={chef.id}><p>Chef Name:</p> {chef.username} </div>)}
          <TopChef />
        </div>
      )
    }

    const Chefs = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_Chefs)


//////////////////////////////ONE RECIPE CONNECTED COMPONENT//////////////////////////////////
/////////////////////////SERVES UP ONE RECIPE BASED ON RECIPE ID/////////////////////////////

const _OneRecipe = ({recipes, users, match}) => {

  //console.log("ONE RECIPE =======", match)

  //const singleRecipe = recipes.filter(recipe => recipe.id === match.params.id)
  //console.log("Single Recipe=====", singleRecipe)

  const singleRecipe = recipes.find(recipe => recipe.id === match.params.id);

  console.log("RECIPE=====", singleRecipe)

  const recipeChef = users.find(user => user.id === singleRecipe.userId)


  console.log("SINGLE RECIPE CHEF=====", recipeChef)


  return (
    <div>
      <h2>Recipe Name: {singleRecipe.name}</h2>
      <h4> Recipe Cuisine: {singleRecipe.cuisine}</h4>
      <h4>Recipe Health Score: {singleRecipe.healthScore} </h4>
      <h4>Recipe Ingredients: {singleRecipe.ingredients} </h4>
      <h4> Recipe Directions: {singleRecipe.directions}</h4>
      <h4> Recipe Image:</h4> <img src={singleRecipe.imageURL} height="150" width="150" />
      <h2> Chef Name: <Link to={`/users/${recipeChef.id}`}> {recipeChef.username}</Link> </h2>
      <h2> Chef Score: {recipeChef.chefscore} </h2>
    </div>
  )
}

const OneRecipe = connect(({recipes, users}) => {
  return {
    recipes,
    users
  }
})(_OneRecipe)


////////////////////////////ONE USER CONNECTED COMPONENT////////////////////////////////////
/////////////////////////SERVES UP ONE USER BASED ON USER ID///////////////////////////////

const _OneUser = ({users, recipes, match}) => {
  console.log("ONE USER =======", match)

  const singleUser = users.find(user => user.id === match.params.id)

  const singleUserRecipes = recipes.filter(recipe => recipe.userId === singleUser.id)

  console.log("Single User Recipes =====", singleUserRecipes)

  console.log("LENGTH CHECK=====", singleUserRecipes.length)

  return (
    <div>
      <h2> User Name: {singleUser.username}</h2>
      <h3>Chef Score: {singleUser.chefscore} </h3>
      <h3> Email: {singleUser.email} </h3>
      <h3> Chef Image: </h3>
      <img src={singleUser.imageURL} height="150" width="150" />
      <h2> Recipes </h2>
      <div>{singleUserRecipes.length > 0 ? singleUserRecipes.map(recipe => <div key={recipe.id}> <Link to={`/recipes/${recipe.id}`}>{recipe.name} </Link> </div>) : <div> There are no recipes for this user </div> } </div>
    </div>
  )
}

const OneUser = connect(({users, recipes}) => {
  return {
    users,
    recipes
  }
})(_OneUser)


////////////////////////////HEALTHY RECIPES CONNECTED COMPONENT////////////////////////////////////
/////////////////////////RETURNS RECIPES WITH HEALTH SCORE ABOVE 8///////////////////////////////

//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================

//CONVERTED TO STARTED JS BELOW - NEED TO REFERENCE AND DISPLAY THIS WITHIN ANOTHER FUNCTION
    const CalcHealthyRecipes = (recipes) => {
      const healthyFood = recipes.filter(recipe => recipe.healthScore >= 8)
      return healthyFood
    }

//BELOW TO BE REMOVED AS IT DOESN'T NEED TO BE CONNECTED COMPONENT - REMOVE ONCE OTHER CODE ABOVE IS BEING USED

    const _HealthyRecipes = ({recipes, users}) => {
      const healthyFood = recipes.filter(recipe => recipe.healthScore >= 8)
      console.log("HEALTHY FOOD====", healthyFood)
      return (
        <div>
          <br />
        There are {healthyFood.length} healthy recipes including {healthyFood.map(food => <p key ={food.name}>{food.name} </p>) }
        <br />

        </div>
      )
    }

    const HealthyRecipes = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_HealthyRecipes)
//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================


////////////////////////////TOP CHEF CONNECTED COMPONENT////////////////////////////////////
/////////////////////////RETURNS THE CHEF WITH THE HIGHEST RATING///////////////////////////

//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================

//CONVERTED TO STARTED JS BELOW - NEED TO REFERENCE AND DISPLAY THIS WITHIN ANOTHER FUNCTION

const calcTopChef = (recipes) => {

  const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)


  let topChef = allChefs[0];

  for (let i=0; i<allChefs.length; i++) {
    if(allChefs[i].chefScore > topChef.chefScore) {
      topChef = allChefs[i];
    }
  }

  return topChef;
}

//BELOW TO BE REMOVED AS IT DOESN'T NEED TO BE CONNECTED COMPONENT - REMOVE ONCE OTHER CODE ABOVE IS BEING USED
    const _TopChef = ({recipes, users}) => {

      const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)

      console.log("All CHEFS IN TOP CHEF FUNCTION ====", allChefs)

      let topChef = allChefs[0];

      for (let i=0; i<allChefs.length; i++) {
        if(allChefs[i].chefScore > topChef.chefScore) {
          topChef = allChefs[i];
        }
      }

      console.log("TOP CHEF =====", topChef);


      return (
        <div>
          The top Chef is {topChef.username}
        </div>
      )
    }


    const TopChef = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_TopChef)
//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================




//////////////////////////////////////////////////////////////////////////////////////
////////////////////////////ADD NEW RECIPE SECTION////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////


//====================WRITE A ROUTE TO ADD A NEW RECIPE===========================
//================================ADD RECIPE======================================
//================================================================================


const _AddRecipe = () => {

}


const AddRecipe = connect(({recipes, users}) => {
  return {
    users,
    recipes
  }
})(_AddRecipe)



//CREATING THE ADD NEW RECIPE AS A CLASS

class _AddNewRecipeForm extends Component {
  constructor() {
    super();

  this.state = {
    name: "",
    cuisine: "",
    healthScore: "",
    ingredients: "",
    directions: "",
    imageURL: ""
    }
    this.createNewRecipe = this.createNewRecipe.bind(this);
  }

  async createNewRecipe(ev) {
    ev.preventDefault()
    await this.props.createNewRecipe(this.state);
  }


  render() {
    const { name, cuisine, healthScore, ingredients, directions, imageURL } = this.state;
    const {createNewRecipe} = this;
    const cuisinesSelect = ['desert', 'italian']

    const healthScores = [0.0, 1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0]
    return (
      <div>
          Add New Recipe Form coming soon...
        <form id="new-recipe-form" onSubmit={createNewRecipe}>
          Recipe Name: <input type="text" name="name" onChange={ev => this.setState({[ev.target.name]: ev.target.value})}/>
          Cuisine: <select> {cuisinesSelect.map(cuisine => <option key={cuisine} value={cuisine}>{cuisine}</option>)} </select>
          Health Score: <select> {healthScores.map(score => <option key={score} value={score}>{score}</option>)} </select>
          Ingredients: <input name="ingredients" type="text" onChange={ev => this.setState({[ev.target.name]: ev.target.value})}/>
          Directions: <input type="text" name="directions" onChange={ev => this.setState({[ev.target.name]: ev.target.value})}/>
          Link to Image (Image URL): <input type="text" name="imageURL" onChange={ev => this.setState({[ev.target.name]: ev.target.value})}/>

          <button type="submit"> Add New Recipe </button>
        </form>

      </div>
    )

  }

}

const AddNewRecipeForm = connect(({recipes,users}) => {
  return {
    recipes,
    users
  }
}, (dispatch) => {
  return {
    createNewRecipe: (recipe) => dispatch(addRecipeThunk(recipe))
    }
  })(_AddNewRecipeForm)



//====================WRITE A ROUTE TO ADD A NEW USER===========================
//================================ADD RECIPE======================================
//================================================================================

const _AddUser = () => {

}

const AddUser = connect(({users, recipes}) => {
  return {
    users,
    recipes
  }
})(_AddUser)



    class App extends Component {
      constructor() {
        super()
        this.state = {
        }
      }

      componentDidMount() {
        fetchRecipes();
        fetchUsers();
      }

      render() {
        return (
          <HashRouter>
            <Route component = {Nav} />
            <Route path = '/' component = { Home } exact />
            <Route path = '/users' component = { Users } exact />
            <Route path = '/recipes' component = { Recipes } exact />
            <Route path = '/chefs' component = { Chefs } exact />
            <Route path = '/recipes/:id' component = { OneRecipe } />
            <Route path = '/users/:id' component = { OneUser } />
            <Route path = '/addrecipe' component = { AddRecipe } />
            <Route path = '/adduser' component = { AddUser } />
          </HashRouter>
        )
      }
    }

    render(<Provider store={store}><App /></Provider>, root)

    </script>
  </body>
</html>
