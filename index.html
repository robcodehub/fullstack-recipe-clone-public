<html>
  <head>
    <script src='/dist/main.js' defer></script>

    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.4/redux.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.0/axios.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-redux/7.1.1/react-redux.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.1/react-router-dom.js'></script>


    <style>

      body {
        font-family: helvetica;
      }

      nav {
        display: flex;
        justify-content: space-around;
      }
    </style>

  </head>
  <body>
    <div id='root'>
    </div>


    <script type='text/babel'>

    //root = div with id of root
    const root = document.querySelector('#root')
    //deconstructing from CDNs - less typing, less griping
    const { Component } = React;
    const { render } = ReactDOM;
    const { HashRouter, Link, Route} = ReactRouterDOM;
    const { createStore, combineReducers } = Redux;
    const { connect, Provider } = ReactRedux;

    //REDUX - ACTION TYPES
    const SET_RECIPES = 'SET_RECIPES'
    const SET_USERS = 'SET_USERS'


    const userReducer = (state = [], action) => {
      //ADD IF ACTION.TYPE HERE
      if (action.type === SET_USERS) {
        state = action.users;
      }
      return state;
    }

    const recipeReducer = (state = [], action) => {
      //ADD IF ACTION.TYPE HERE
      if (action.type === SET_RECIPES) {
        state = action.recipes;
      }
      return state;
    }


    //REDUX - COMBINE REDUCERS
    const reducer = combineReducers({
      users: userReducer,
      recipes: recipeReducer
    });

    //REDUX - CREATE REDUX STORE
      const store = createStore(reducer);


    //REDUX - AXIOS - FETCH RECIPES / USERS AND ADD TO STORE

    const fetchRecipes = async() => store.dispatch({type: SET_RECIPES, recipes: (await axios.get('/api/recipes')).data})

    const fetchUsers = async() => store.dispatch({type: SET_USERS, users: (await axios.get('/api/users')).data})


    const _Home = ({users, recipes}) => {
      console.log("RECIPES ON HOME PAGE SHOW...", recipes)
      let allRecipes = [];
      recipes


    return (
          <div>
            Welcome! {users.length} users and {recipes.length} recipes coming soon...

            <HealthyRecipes />
            The top chef is...
          </div>
        )
    }

    //HOME CONNECTED COMPONENT
    const Home = connect(({users, recipes}) => {
      return {
        users,
        recipes
      }
    })(_Home)

    const _Recipes = ({recipes}) => {
      const chefsTest = recipes.filter(recipe => recipe.user)
      console.log("RECIPES =======", recipes)
      console.log("RECIPES WITH CHEF =======", chefsTest)
      return (
        <div>
          {recipes.map(recipe => <div key = {recipe.id} > <br /> Name: {recipe.name} <br /> Cuisine: {recipe.cuisine} <br /> Health Score: {recipe.healthScore} <br /> Directions: {recipe.directions} <br /> Image: <br /> <img height="250" width="250" src={recipe.imageURL} /> <Link to={`/recipes/${recipe.id}`}>Link to Recipe</Link> </div>)}
        </div>
      )
    }

    const Recipes = connect(({recipes}) => {
      return {
        recipes
      }
    })(_Recipes)



    const _Users = ({users}) => {
      return (
        <div>
          {users.length} Users coming soon...
          {users.map(user => <div key={user.id}> <br /> Chef Name: {user.username} <br /> Chef Score: {user.chefScore} <br /> Profile Image: <br /> <img height="150" width="150" src={user.imageURL} /> <Link to={`/users/${user.id}`}> Link to User</Link> <br /></div>)}
        </div>
      )
    }

    const Users = connect(({users}) => {
      return {
        users
      }
    })(_Users);

    const _Nav = ({recipes, users}) => {
      return (
        <nav>
          <Link to='/'> Home </Link>
          <Link to='/users'> Users ({users.length}) </Link>
          <Link to='/recipes'> Recipes ({recipes.length})</Link>
          <Link to='/chefs'> Chefs ({(recipes.filter(recipe => recipe.userId !== null)).length})</Link>

        </nav>
      )
    }

    const Nav = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_Nav)




    //{recipes.filter(recipe => recipe.user)}
    const _Chefs = ({recipes, users}) => {

      const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)

      console.log("All CHEFS====", allChefs)



      /*
      const reducedChefs = allChefs.reduce((all, chef) => {
        if (!all[chef.id]) {
          all[chef.id] = chef;
        }
        return all;
      }, {});

      const reducedArr = [];
      reducedArr.push(reducedChefs);

      console.log("REDUCED Arr =======", reducedArr)

      console.log("REDUCED CHEFS =======", reducedChefs)
      */

      return (
        <div>
          {allChefs.map(chef => <div key={chef.id}><p>Chef Name:</p> {chef.username} </div>)}
          <TopChef />
        </div>
      )
    }

    const Chefs = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_Chefs)


//SERVES UP ONE RECIPE
/////////////////////////////

const _OneRecipe = ({recipes, users, match}) => {

  //console.log("ONE RECIPE =======", match)

  //const singleRecipe = recipes.filter(recipe => recipe.id === match.params.id)
  //console.log("Single Recipe=====", singleRecipe)

  const singleRecipe = recipes.find(recipe => recipe.id === match.params.id);

  console.log("RECIPE=====", singleRecipe)

  const recipeChef = users.find(user => user.id === singleRecipe.userId)


  console.log("SINGLE RECIPE CHEF=====", recipeChef)


  return (
    <div>
      <h2>Recipe Name: {singleRecipe.name}</h2>
      <h2> Chef Name: {recipeChef.username} </h2>
      <p> Full recipe coming soon...</p>
    </div>
  )
}

const OneRecipe = connect(({recipes, users}) => {
  return {
    recipes,
    users
  }
})(_OneRecipe)

//DISPLAYS ONE USER

const _OneUser = ({users, recipes, match}) => {
  console.log("ONE USER =======", match)

  const singleUser = users.find(user => user.id === match.params.id)

  const singleUserRecipes = recipes.filter(recipe => recipe.userId === singleUser.id)

  console.log("Single User Recipes =====", singleUserRecipes)

  return (
    <div>
      <h2> User Name:</h2>
      Details coming soon for {singleUser.username}
      <h2> Recipes </h2>
      <div>{singleUserRecipes.map(recipe => <div key={recipe.id}> {recipe.name} </div>) } </div>
    </div>
  )
}

const OneUser = connect(({users, recipes}) => {
  return {
    users,
    recipes
  }
})(_OneUser)

//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================

//CONVERTED TO STARTED JS BELOW - NEED TO REFERENCE AND DISPLAY THIS WITHIN ANOTHER FUNCTION
    const CalcHealthyRecipes = (recipes) => {
      const healthyFood = recipes.filter(recipe => recipe.healthScore >= 8)
      return healthyFood
    }

//BELOW TO BE REMOVED AS IT DOESN'T NEED TO BE CONNECTED COMPONENT - REMOVE ONCE OTHER CODE ABOVE IS BEING USED

    const _HealthyRecipes = ({recipes, users}) => {
      const healthyFood = recipes.filter(recipe => recipe.healthScore >= 8)
      console.log("HEALTHY FOOD====", healthyFood)
      return (
        <div>
          <br />
        There are {healthyFood.length} healthy recipes including {healthyFood.map(food => <p key ={food.name}>{food.name} </p>) }
        <br />

        </div>
      )
    }

    const HealthyRecipes = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_HealthyRecipes)
//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================


//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================

//CONVERTED TO STARTED JS BELOW - NEED TO REFERENCE AND DISPLAY THIS WITHIN ANOTHER FUNCTION

const calcTopChef = (recipes) => {

  const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)


  let topChef = allChefs[0];

  for (let i=0; i<allChefs.length; i++) {
    if(allChefs[i].chefScore > topChef.chefScore) {
      topChef = allChefs[i];
    }
  }

  return topChef;
}

//BELOW TO BE REMOVED AS IT DOESN'T NEED TO BE CONNECTED COMPONENT - REMOVE ONCE OTHER CODE ABOVE IS BEING USED
    const _TopChef = ({recipes, users}) => {

      const allChefs = (recipes.filter(recipe => recipe.userId !== null)).map(recipe => recipe.user)

      console.log("All CHEFS IN TOP CHEF FUNCTION ====", allChefs)

      let topChef = allChefs[0];

      for (let i=0; i<allChefs.length; i++) {
        if(allChefs[i].chefScore > topChef.chefScore) {
          topChef = allChefs[i];
        }
      }

      console.log("TOP CHEF =====", topChef);


      return (
        <div>
          The top Chef is {topChef.username}
        </div>
      )
    }


    const TopChef = connect(({recipes, users}) => {
      return {
        recipes,
        users
      }
    })(_TopChef)
//==================CHANGES TO MAKE===============================================
//SHOULDN'T BE A CONNECTED COMPONENT - FINE FOR NOW BUT CONVERT TO JS FUNCTION LATER
//==================CHANGES TO MAKE===============================================







    class App extends Component {
      constructor() {
        super()
        this.state = {
        }
      }

      componentDidMount() {
        fetchRecipes();
        fetchUsers();
      }

      render() {
        return (
          <HashRouter>
            <Route component = {Nav} />
            <Route path = '/' component = { Home } exact />
            <Route path = '/users' component = { Users } exact />
            <Route path = '/recipes' component = { Recipes } exact />
            <Route path = '/chefs' component = { Chefs } exact />
            <Route path = '/recipes/:id' component = { OneRecipe } />
            <Route path = '/users/:id' component = { OneUser } />
          </HashRouter>
        )
      }
    }

    render(<Provider store={store}><App /></Provider>, root)

    </script>
  </body>
</html>
